
a **textual visualization** of how the **input broker (`ibroker.c`)** routes events. 
Think of it like a flowchart written in words, 
showing all the possible paths an input event can take:

---

# ðŸŽ› Input Broker Flow (Textual Visualization)

### 1. **Event Sources**
- **Keyboard (PS/2)** â†’ scancodes, ASCII, control combos  
- **Mouse (PS/2)**    â†’ movement, clicks, scroll  
- **Timer (PIT)**     â†’ periodic ticks, scheduling events  

---

### 2. **Broker Entry Point**
- All raw events arrive in the **input broker**.  
- Broker decides: *where should this event go?*

---

### 3. **Routing Targets**
- **Display Server Queue** (`ibroker_post_message_to_ds`)  
  - GUI events (mouse clicks, window focus, arrow docking combos, `[Ctrl+W]` close).  
- **Foreground App Queue** (`ibroker_post_message_to_fg_thread`)  
  - Applicationâ€‘level combos (DC1â€“DC4, Ctrl+C, Ctrl+Z, etc.).  
- **STDIN / TTY** (`ibroker_send_ascii_to_stdin`)  
  - Raw ASCII characters for terminal/console input.  
- **Kernel Internal Handlers**  
  - Special combos like CAD (Ctrl+Alt+Del â†’ reboot), entering/exiting embedded shell, launching apps via init process.  

---

### 4. **Keyboard Event Processing**
- **Normal keys** â†’ ASCII â†’ sent to STDIN/TTY.  
- **Extended keys (arrows, ins/del/home/end)** â†’ processed in `__ProcessExtendedKeyboardKeyStroke`.  
  - **Ctrl+Arrow** â†’ sent to **server** for docking.  
  - Other extended keys â†’ may be sent to server or ignored.  
- **Control combos**:  
  - `[Ctrl+W]` â†’ `MSG_CLOSE` â†’ server â†’ forwarded to client.  
  - `[Ctrl+Q/R/S/T]` â†’ DC1â€“DC4 â†’ sent to **foreground app**.  
  - `[Ctrl+C]` â†’ ASCII_ETX â†’ app decides (cancel/copy).  
  - `[Ctrl+Z]` â†’ ASCII_SUB â†’ app decides (undo/suspend).  

---

### 5. **Mouse Event Processing**
- Movement, button clicks, scroll â†’ always routed to **server queue**.  
- Server interprets them as window actions (focus, resize, drag, etc.).  

---

### 6. **Timer Event Processing**
- PIT ticks â†’ routed internally to **scheduler** or **server** (for GUI refresh).  
- Can trigger periodic messages like `MSG_TIMER`.  

---

### 7. **Special Cases**
- **CAD (Ctrl+Alt+Del)** â†’ if allowed, triggers `do_reboot()`.  
- **Embedded Shell** â†’ enter/exit via broker commands.  
- **Init Process Launch** â†’ broker sends `MSG_COMMAND` to init thread for app startup.  

---

# ðŸ—‚ Summary Table

| Source     | Example Event      | Destination         | Notes |
|------------|--------------------|---------------------|-------|
| Keyboard   | ASCII key          | STDIN/TTY           | Console input |
| Keyboard   | Ctrl+Arrow         | Server Queue        | Dock/Tile windows |
| Keyboard   | Ctrl+W             | Server â†’ Client     | Close active window |
| Keyboard   | Ctrl+Q/R/S/T       | Foreground App      | DC1â€“DC4 (apps decide meaning) |
| Keyboard   | Ctrl+C / Ctrl+Z    | Foreground App      | Cancel / Undo |
| Mouse      | Click, move, scroll| Server Queue        | GUI events |
| Timer      | PIT tick           | Scheduler/Server    | Refresh, scheduling |
| Special    | CAD (Ctrl+Alt+Del) | Kernel Internal     | Reboot if allowed |

---

This textual visualization shows the **full routing map**: 
from raw input â†’ broker â†’ server/app/tty/kernel.  

